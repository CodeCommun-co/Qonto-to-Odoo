{% extends 'base.html' %}
{% block content %}

    <div>
        {{ message }}
    </div>
    <div>
        <h2>Qonto</h2>
        <h3>Table des User et bénéficiares Qonto</h3>
        <form action="/" method="post">
            {% csrf_token %}
            <input id="get_qonto_contact" style="display: None" name="get_qonto_contact" value="get_qonto_contact">
            <input type="submit" value="Get Contacts">
        </form>
        <button type="button" onclick="submit_form()">Valider les changements</button>

        <table>
            <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>Liaison Odoo</th>
                <th>changez de liaison</th>
                <th>Créer Odoo Contact</th>
            </tr>
            <form id="odoo_contact_select" action="/" method="post">
                {% csrf_token %}
                {% for contact in qonto_contacts %}

                    <tr>
                        <td>{{ contact }}</td>
                        <td>{{ contact.email }}</td>
                        <td>{{ contact.odoo_contact }}</td>
                        <td>
                            <label for="odoo_contact_select{{ contact.uuid }}"></label>
                            <select name="odoo_contact_select_{{ contact.uuid }}"
                                    id="odoo_contact_select{{ contact.uuid }}">
                                <option value="None">Changez de compte</option>
                                {% for odoo_contact in odoo_contacts %}
                                    <option value="{{ odoo_contact.uuid }}">{{ odoo_contact }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button type="button" onclick="send_to_odoo('{{ contact.uuid }}')">Create to Odoo</button>
                        </td>

                    </tr>
                {% endfor %}
            </form>
        </table>


        <form action="/" method="post">
            {% csrf_token %}
            <input id="get_labels" style="display: None" name="button_action_qonto" value="get_labels">
            <input type="submit" value="Get Labels">
        </form>
        <table>
            <tr>
                <th>Parent</th>
                <th>Label</th>
                <th>Compte analytique Odoo</th>
                <th>Changez de compte</th>
            </tr>

            <form action="/" method="post">
                {% csrf_token %}

                {% for parent, childs in labels.items %}
                    {% for child in childs %}

                        <tr>
                            <td>{{ parent.name }}</td>
                            <td>{{ child.name }}</td>
                            <td>{{ child.odoo_analytic_account }}</td>
                            <td>

                                <label for="odoo_account_select"> -> </label>
                                <select name="odoo_account_select_{{ child.uuid }}"
                                        id="odoo_account_select_{{ child.uuid }}">
                                    <option value="None">Changez de compte</option>

                                    {% for account in account_analytic %}
                                        <option value="{{ account.uuid }}">{{ account }}</option>
                                    {% endfor %}
                                </select>

                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                <input type="submit" value="MAJ">
            </form>
        </table>
    </div>


    <div>
        <h2>Odoo</h2>
        <h3>Table des account.journal Odoo</h3>
        <form action="/" method="post">
            {% csrf_token %}
            <input id="get_account_journal" style="display: None" name="button_action_odoo" value="get_account_journal">
            <input type="submit" value="Get account.journal">
        </form>
        <table>
            <tr>
                <th>Journal</th>
            </tr>

            {% for journal in account_journal %}
                <tr>
                    <td>{{ journal.name }}</td>
                </tr>
            {% endfor %}
        </table>


        <h3>Table des account.journal Odoo</h3>
        <form action="/" method="post">
            {% csrf_token %}
            <input id="get_account_analytic" style="display: None" name="button_action_odoo"
                   value="get_account_analytic">
            <input type="submit" value="Get account.analytic">
        </form>
        <table>
            <tr>
                <th>Groupe</th>
                <th>Journal</th>
                <th>Code</th>
            </tr>

            {% for account in account_analytic %}
                <tr>
                    <td>{{ account.group.name }}</td>
                    <td>{{ account.name }}</td>
                    <td>{{ account.code }}</td>
                </tr>
            {% endfor %}
        </table>

        <h3>Table des Transactions Qonto</h3>
        <form action="/" method="post">
            {% csrf_token %}
            <input id="get_transactions" style="display: None" name="button_action_qonto" value="get_transactions">
            <input type="submit" value="Get transactions">
        </form>

        {% for iban, side in alltransactions.items %}
            <div style="margin: 1em 0">
                <strong>Compte : {{ iban.name }}</strong>
                {% for creditORdebit, transaction_list in side.items %}
                    <div style="margin: 1em 0">
                        {% if creditORdebit == 'C' %}<strong>Crédits</strong>{% else %}
                            <strong>Débits</strong>{% endif %}
                        <table>
                            <tr>
                                <th>emitted_at</th>
                                <th>label</th>
                                <th>category</th>
                                <th>note</th>
                                <th>amount_cents</th>
                                <th>vat_amount_cents</th>
                                <th>initiator</th>
                                <th>attachment</th>
                                <th>Beneficiaire</th>
                            </tr>

                            {% for transaction in transaction_list %}
                                <tr>
                                    <td>{{ transaction.emitted_at }}</td>
                                    <td>{{ transaction.label }}</td>
                                    <td>{{ transaction.category }}</td>
                                    <td>{{ transaction.note }}</td>
                                    <td>{{ transaction.amount_cents }}</td>
                                    <td>{{ transaction.vat_amount_cents }}</td>
                                    <td>{{ transaction.initiator }}</td>
                                    <td>
                                        {% for attachment in transaction.attachments.all %}
                                            <a href="{{ attachment.url_qonto }}">A{{ forloop.counter }}</a>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% if transaction.beneficiary %}
                                            {{ transaction.beneficiary }}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>

                    </div>
                {% endfor %}

            </div>
        {% endfor %}


    </div>
{% endblock %}

{% block javascript %}
    <script>
        function send_to_odoo(contact_uuid) {
            window.location.href = "/create_odoo_contact/" + contact_uuid;
        };

        function submit_form() {
            document.getElementById("odoo_contact_select").submit();
        };
    </script>
{% endblock %}